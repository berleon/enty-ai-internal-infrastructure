# Tailscale Ingress for Forgejo
# Exposes Forgejo via Tailscale network
#
# Prerequisites:
# - Tailscale Kubernetes operator installed (run: ./scripts/setup-tailscale.sh)
# - Forgejo service deployed in forgejo namespace
#
# Usage:
# kubectl apply -f apps/forgejo-tailscale-ingress.yaml
#
# Access:
# http://forgejo.TAILNET_NAME (e.g., http://forgejo.user.github)
#

apiVersion: v1
kind: Service
metadata:
  name: forgejo-tailscale
  namespace: forgejo
  annotations:
    tailscale.com/expose: "true"
    tailscale.com/hostname: "forgejo"  # Will be: forgejo.TAILNET_NAME
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: forgejo
  ports:
    - name: http
      port: 80
      targetPort: 3000
      protocol: TCP
  # Tailscale operator will automatically:
  # 1. Create a Tailscale device for this service
  # 2. Route traffic through the Tailscale network
  # 3. Make it accessible as forgejo.TAILNET_NAME
---
# Ingress to expose the Forgejo service via Tailscale
# This tells Tailscale to accept traffic on port 80 and forward to the service
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: forgejo-tailscale
  namespace: forgejo
spec:
  ingressClassName: tailscale
  rules:
    - host: forgejo
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: forgejo-http
                port:
                  number: 3000
