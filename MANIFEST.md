# Implementation Manifest

Complete inventory of Ironclad infrastructure implementation.

---

## Overview

**Project:** Ironclad - Self-hosted private Kubernetes stack on Hetzner Cloud
**Status:** ✓ Complete - Ready for deployment
**Total Files:** 18 files
**Total Lines:** 5,294 lines

---

## File Structure

```
enty-ai-internal-infrastructure/
├── Documentation (7 files)
│   ├── CLAUDE.md                 # AI guidance & architecture (644 lines)
│   ├── README.md                 # Full reference guide (430 lines)
│   ├── QUICKSTART.md             # 30-minute setup guide (293 lines)
│   ├── TERRAFORM_SETUP.md        # Terraform details (463 lines)
│   ├── CONFIGURATION.md          # All component configs (619 lines)
│   ├── PLAN.md                   # Original plan (470 lines)
│   └── MANIFEST.md               # This file
│
├── Terraform Infrastructure (4 files)
│   └── infra/
│       ├── main.tf               # K3s cluster definition (48 lines)
│       ├── variables.tf          # Input variables (77 lines)
│       ├── outputs.tf            # Cluster outputs (63 lines)
│       ├── backend.tf            # State management (28 lines)
│       ├── kube.tfvars.example   # Configuration template (73 lines)
│       └── .terraform/           # Generated by 'terraform init'
│
├── Kubernetes Applications (3 files)
│   └── apps/
│       ├── forgejo.yaml          # Git server Helm app (101 lines)
│       ├── runner.yaml           # CI/CD runners Helm app (78 lines)
│       └── backup.yaml           # Database backups CronJob (144 lines)
│
├── Helper Scripts (2 files)
│   └── scripts/
│       ├── control.sh            # Control center CLI (220 lines)
│       └── dashboard.py          # Health dashboard (319 lines)
│
├── Configuration
│   ├── .gitignore                # Secret protection rules
│   └── terraform-hetzner-readme.md # Terraform module reference
│
└── .git/                          # Git repository

```

---

## What Was Implemented

### 1. Documentation Suite (3,519 lines)

| File | Purpose | Audience |
|------|---------|----------|
| **CLAUDE.md** | AI system guidance, architecture overview, design decisions | Claude Code, DevOps engineers |
| **README.md** | Quick start, file structure, common tasks, troubleshooting | Everyone, first read |
| **QUICKSTART.md** | 30-minute end-to-end setup guide with copy-paste commands | New users, fast path |
| **TERRAFORM_SETUP.md** | Detailed Terraform configuration, server types, management | Infrastructure engineers |
| **CONFIGURATION.md** | Exhaustive reference for all configurable components | Advanced users, maintainers |
| **PLAN.md** | Original project plan (preserved for reference) | Context, history |
| **MANIFEST.md** | This file - inventory and checklist | Project status |

**Key Documentation Features:**
- Step-by-step instructions with command examples
- Troubleshooting guides with root cause analysis
- Architecture diagrams (in ASCII)
- Server type comparison tables
- Workflow examples (.forgejo/workflows/)
- Quick reference tables

### 2. Infrastructure as Code (216 lines)

**Terraform Configuration** (`infra/`)
- `main.tf` - Declares K3s cluster using terraform-hcloud-kubernetes module
- `variables.tf` - All configurable parameters (cluster size, server type, etc.)
- `outputs.tf` - Cluster info (IP, kubeconfig, connection details)
- `backend.tf` - State management setup guide
- `kube.tfvars.example` - Configuration template with sensible defaults

**Key Features:**
- ✓ Single-node deployment (cost: ~€9/month)
- ✓ Auto-updates via MicroOS
- ✓ Firewall-protected
- ✓ Auto-generated kubeconfig
- ✓ Module-based (uses official terraform-hcloud-kubernetes)

### 3. Kubernetes Applications (323 lines)

**Argo CD Application Manifests** (`apps/`)

1. **forgejo.yaml** (101 lines)
   - Private Git server
   - Helm-based deployment
   - Persistent storage via Hetzner volumes
   - PostgreSQL database
   - Tailscale ingress
   - Configurable admin credentials

2. **runner.yaml** (78 lines)
   - Forgejo Runners for CI/CD
   - Docker-in-Docker for builds
   - Configurable labels (ubuntu-latest, debian-latest, etc.)
   - Resource limits (CPU/RAM)
   - Auto-registration from Forgejo

3. **backup.yaml** (144 lines)
   - Daily CronJob at 3 AM UTC
   - Database dump to zip file
   - Upload to S3 (AWS, MinIO, etc.)
   - Role-based access control
   - Service account for security

**Key Features:**
- ✓ GitOps-ready (commit changes to trigger deployments)
- ✓ Automatic sync (Argo CD auto-deploys on config repo changes)
- ✓ High availability options (can scale to 3+ replicas)
- ✓ Off-site backup to S3

### 4. Helper Scripts (539 lines)

**`scripts/control.sh`** (220 lines)
- **Purpose:** Control center for cluster operations
- **Commands:**
  - `status` - Python dashboard health check
  - `ui-argo` - Port-forward & open Argo CD UI
  - `ui-git` - Open Forgejo via Tailscale
  - `backup-now` - Trigger manual backup
  - `logs-backup` - View backup job logs
  - `top` - Real-time pod metrics
  - `pods` - List all pods
- **Features:** Color output, error handling, context support

**`scripts/dashboard.py`** (319 lines)
- **Purpose:** Real-time cluster health dashboard
- **Shows:**
  - Node status (CPU, RAM, readiness)
  - Pod health (restarts, status)
  - Deployment status (ready replicas)
  - Backup age (critical monitoring)
- **Features:** Rich UI, automatic Kubernetes API connection

### 5. Security Configuration

**`.gitignore`** - Protects:
- `*.tfvars` files (API tokens)
- `terraform.tfstate` (sensitive state)
- `.env` and secrets files
- Kubeconfig files
- IDE and backup files

---

## Deployment Checklist

### Phase 1: Infrastructure Setup
- [ ] Install Terraform, kubectl, Python
- [ ] Generate Hetzner Cloud API token
- [ ] Copy `kube.tfvars.example` → `kube.tfvars`
- [ ] Edit `kube.tfvars` with API token
- [ ] Run `terraform init && terraform apply`
- [ ] Verify: `kubectl get nodes`

### Phase 2: Secure Network (Tailscale)
- [ ] Generate Tailscale OAuth credentials
- [ ] Install Tailscale operator via Helm
- [ ] Verify: `tailscale status`
- [ ] Test DNS: `dig git-forge.ts`

### Phase 3: GitOps Setup (Argo CD)
- [ ] Install Argo CD
- [ ] Port-forward and access UI
- [ ] Get admin password
- [ ] Create private config repository
- [ ] Connect Argo CD to config repo

### Phase 4: Deploy Applications
- [ ] Copy `apps/forgejo.yaml` to config repo
- [ ] Copy `apps/runner.yaml` to config repo
- [ ] Copy `apps/backup.yaml` to config repo
- [ ] Edit credentials (admin password, S3 keys)
- [ ] Commit and push to config repo
- [ ] Monitor Argo CD sync
- [ ] Verify Forgejo runs: `kubectl get pods -n forgejo`

### Phase 5: Configure CI/CD
- [ ] Get Forgejo runner token
- [ ] Update `runner.yaml` with token
- [ ] Commit config repo
- [ ] Verify runner shows as "Online" in Forgejo
- [ ] Test with sample workflow

### Phase 6: Backup Testing
- [ ] Create S3 bucket
- [ ] Create Kubernetes secret with S3 credentials
- [ ] Trigger manual backup: `./scripts/control.sh backup-now`
- [ ] Verify backup appears in S3
- [ ] Test restore process

### Phase 7: Post-Deployment
- [ ] Run `./scripts/control.sh status` daily
- [ ] Document Tailscale network
- [ ] Set up monitoring alerts
- [ ] Configure Slack notifications (optional)
- [ ] Plan maintenance schedule

---

## Technology Stack Summary

| Layer | Technology | Version | Cost |
|-------|-----------|---------|------|
| **Cloud** | Hetzner Cloud | — | €9/mo |
| **OS** | openSUSE MicroOS | Latest | Included |
| **Orchestration** | K3s | 1.30+ | Free |
| **VPN** | Tailscale | Latest | Free tier |
| **Git Server** | Forgejo | 9.0.0+ | Free |
| **CI/CD** | Forgejo Runners | Latest | Free |
| **GitOps** | Argo CD | 2.10+ | Free |
| **Storage** | Hetzner Volumes | — | ~€0.05/GB/mo |
| **Backups** | AWS S3 | — | Pay per GB |

**Monthly Cost Estimate:**
- Server (cpx21): €9
- Storage (50GB): €2.50
- S3 Backups (1GB/day): ~€1
- **Total: ~€12.50/month**

---

## Architecture Highlights

### Data Flow
```
Your Laptop (Tailscale VPN)
    ↓
MagicDNS (git-forge.ts)
    ↓
K8s Ingress (Tailscale Operator)
    ↓
Forgejo Pod → Git operations, User management
    ↓
Forgejo Runners → Build jobs, CI/CD workflows
    ↓
CronJob (Daily 3 AM) → Database dump
    ↓
S3 Backup → Off-site safety net
```

### Security Model
- ✓ No open ports (Tailscale VPN only)
- ✓ Auto-updating OS (MicroOS)
- ✓ Encrypted backups (S3)
- ✓ Pod isolation (Kubernetes)
- ✓ Secret management (K8s secrets)
- ✓ Role-based access (RBAC)

### High Availability Options
- Single-node: ✓ (current)
- HA: Upgrade control_plane_count to 3
- Scaling: Add agent_node_pools for workers
- Multi-region: Requires DNS failover

---

## Key Design Decisions

1. **Single-Node K3s**
   - Cost-effective (~€9/month vs €30+ for HA)
   - Suitable for private internal infrastructure
   - Can upgrade to HA later without code changes

2. **MicroOS for Zero-Maintenance**
   - Auto-updates with automatic rollback
   - Eliminates manual OS patching
   - Btrfs snapshots for recovery

3. **Tailscale for Security**
   - No public ports, completely private
   - MagicDNS for auto-HTTPS certificates
   - VPN-based access (zero-trust)

4. **GitOps with Argo CD**
   - Infrastructure-as-code
   - Config repo is "backup brain"
   - Automatic sync on code changes

5. **Daily Backups to S3**
   - Off-site safety net
   - Cost-effective (~€1/month)
   - Can restore to different infrastructure

6. **Terraform for Infrastructure**
   - Reproducible deployments
   - Version control
   - Easy scaling

---

## Maintenance & Operations

### Daily (5 minutes)
```bash
./scripts/control.sh status
# Check: nodes healthy, pods running, backup age < 24h
```

### Weekly (10 minutes)
```bash
k9s  # Real-time dashboard
# Monitor: CPU/RAM usage, restart counts
```

### Monthly (30 minutes)
- Test backup restoration
- Review pod logs for errors
- Check Hetzner billing
- Verify S3 bucket growth

### Quarterly (2 hours)
- Update K3s version
- Update Forgejo
- Rotate S3 credentials
- Review security settings

---

## Future Enhancements

### Short-term (Low Effort)
- [ ] Add Prometheus monitoring
- [ ] Set up Slack alerts
- [ ] Create sample workflows
- [ ] Document team onboarding

### Medium-term (Medium Effort)
- [ ] Upgrade to HA (3 control planes)
- [ ] Add worker nodes
- [ ] Implement pod autoscaling
- [ ] Add container image registry

### Long-term (High Effort)
- [ ] Multi-region failover
- [ ] Disaster recovery procedures
- [ ] Cost optimization analysis
- [ ] Performance benchmarking

---

## Troubleshooting Quick Links

| Issue | Solution |
|-------|----------|
| K8s won't start | TERRAFORM_SETUP.md → Troubleshooting |
| Forgejo crashes | CONFIGURATION.md → Forgejo troubleshooting |
| Runners offline | CONFIGURATION.md → Runner troubleshooting |
| Backups failing | CONFIGURATION.md → Backup restoration |
| Can't access via Tailscale | CONFIGURATION.md → Tailscale troubleshooting |
| General K8s issues | README.md → Troubleshooting |

---

## File Permissions & Safety

- ✓ `scripts/control.sh` - Executable (755)
- ✓ `scripts/dashboard.py` - Executable (644)
- ✓ `.gitignore` - Protects secrets
- ✓ `*.tfvars` - NOT committed (gitignored)
- ✓ `terraform.tfstate` - NOT committed (gitignored)

---

## Success Criteria Checklist

After following the guides, you should have:

- [ ] K3s cluster running on Hetzner Cloud
- [ ] Kubeconfig working locally
- [ ] Tailscale VPN configured
- [ ] Argo CD managing cluster state
- [ ] Forgejo accessible via HTTPS
- [ ] Forgejo Runners ready for CI/CD
- [ ] Daily backups running to S3
- [ ] Dashboard showing green status
- [ ] Cost < €20/month
- [ ] Zero required manual updates to OS

---

## Support & References

- **Terraform:** https://www.terraform.io/docs/
- **K3s:** https://docs.k3s.io/
- **Hetzner Cloud:** https://docs.hetzner.cloud/
- **Forgejo:** https://forgejo.org/docs/
- **Argo CD:** https://argo-cd.readthedocs.io/
- **Tailscale:** https://tailscale.com/kb/
- **Kubernetes:** https://kubernetes.io/docs/

---

## Version History

| Date | Version | Changes |
|------|---------|---------|
| 2026-01-16 | 1.0 | Initial implementation complete |

---

## Next Steps

1. **Read:** Start with `QUICKSTART.md` for 30-minute setup
2. **Setup:** Follow Phase 1 in `TERRAFORM_SETUP.md`
3. **Deploy:** Use `README.md` for phases 2-6
4. **Customize:** Refer to `CONFIGURATION.md` for tweaks
5. **Maintain:** Run `./scripts/control.sh status` daily

---

**Status:** ✓ Ready for Deployment
**Complexity:** Intermediate (requires Terraform, K8s, Git knowledge)
**Estimated Setup Time:** 30 minutes (infrastructure) + 30 minutes (configuration)
**Support:** See CLAUDE.md for AI-friendly guidance

---

**Last Updated:** 2026-01-16
