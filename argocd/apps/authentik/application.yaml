apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: authentik
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://charts.goauthentik.io
    targetRevision: '2025.12.1'
    chart: authentik
    helm:
      releaseName: authentik
      values: |
        global:
          podAnnotations:
            # Tailscale proxy annotations for admin interface access
            tailscale.com/expose: "true"

        authentik:
          # Secret key from secret
          secret_key: "file:///secrets/config/secret_key"
          error_reporting:
            enabled: false  # Privacy-conscious

          postgresql:
            # Connect to shared PostgreSQL cluster
            host: "postgres-shared-rw.database.svc.cluster.local"
            port: 5432
            name: "authentik"
            user: "authentik"
            password: "file:///secrets/postgres/password"

        server:
          replicas: 1
          resources:
            requests:
              cpu: 50m
              memory: 300Mi
            limits:
              cpu: 500m
              memory: 800Mi

          # Mount secrets
          volumes:
            - name: config-secret
              secret:
                secretName: authentik-config
            - name: postgres-secret
              secret:
                secretName: authentik-postgres-credentials
                items:
                  - key: password
                    path: password

          volumeMounts:
            - name: config-secret
              mountPath: /secrets/config
              readOnly: true
            - name: postgres-secret
              mountPath: /secrets/postgres
              readOnly: true

        worker:
          replicas: 1
          resources:
            requests:
              cpu: 50m
              memory: 300Mi
            limits:
              cpu: 500m
              memory: 600Mi

          # Mount secrets
          volumes:
            - name: config-secret
              secret:
                secretName: authentik-config
            - name: postgres-secret
              secret:
                secretName: authentik-postgres-credentials
                items:
                  - key: password
                    path: password

          volumeMounts:
            - name: config-secret
              mountPath: /secrets/config
              readOnly: true
            - name: postgres-secret
              mountPath: /secrets/postgres
              readOnly: true

        # Disable bundled PostgreSQL
        postgresql:
          enabled: false

  destination:
    server: https://kubernetes.default.svc
    namespace: authentik

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
