apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Argo CD installation from upstream
namespace: argocd

# Reference upstream Argo CD manifests
resources:
  - https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Apply SOPS/KSOPS configuration patches
patchesStrategicMerge:
  - patches/repo-server-deployment.yaml

patchesJson6902:
  - target:
      group: v1
      version: v1
      kind: ConfigMap
      name: argocd-cm
      namespace: argocd
    patch: |-
      # Note: kustomize.version causes a parsing bug in Argo CD 3.2.5, so we only set buildOptions
      - op: add
        path: /data/kustomize.buildOptions
        value: "--enable-alpha-plugins --enable-exec"
