apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Argo CD installation from upstream with KSOPS support
namespace: argocd

# Reference upstream Argo CD manifests
resources:
  - https://raw.githubusercontent.com/argoproj/argo-cd/refs/tags/v3.2.5/manifests/install.yaml

# Apply SOPS/KSOPS configuration using shared patch
patches:
  # Strategic merge patch for repo-server KSOPS configuration
  - path: patches/repo-server-ksops.yaml
  # Strategic merge patches for resource limits (optimize for 4GB node)
  - path: patches/resource-limits.yaml
  # JSON patch for argocd-cm ConfigMap (enable kustomize plugins)
  - target:
      group: ""
      version: v1
      kind: ConfigMap
      name: argocd-cm
      namespace: argocd
    patch: |-
      - op: add
        path: /data/kustomize.buildOptions
        value: "--enable-alpha-plugins --enable-exec"
